<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body onload="setDebugSessionStorage()">

<!-- Input Field -->
<input type="text" id="userInput" placeholder="Input Your Address or Postal Code">

<!-- Button to trigger action -->
<button onclick="submitLocationAsync()">Submit</button>

<!-- Area to display the input -->
<p id="debug"></p>
<p id="latlong"></p>
<p id="address"></p>
<img id="map" src="https://www.onemap.gov.sg/api/staticmap/getStaticImage?layerchosen=default&zoom=11&height=450&width=450&lat=1.366667&lng=103.8" alt="map of singapore">
<!-- JavaScript code to handle the input -->
<script>
    function setDebugSessionStorage(){
        sessionStorage.setItem("category","CashForTrash");
    }
    function getDebugSessionStorage(){
        sessionStorage.getItem("category");
    }

    let start = new Map();
    let displayedlocations = [];
    const locationDirectDistanceComparator = (a, b) =>
        ((a["Longitude"]-start.get("long"))**2+(a["Latitude"]-start.get("lat"))**2)**0.5 -
        ((b["Longitude"]-start.get("long"))**2+(b["Latitude"]-start.get("lat"))**2)**0.5;

    const addressResolverUri = str =>
        `https://www.onemap.gov.sg/api/common/elastic/search?searchVal=${str}&returnGeom=Y&getAddrDetails=N`;
    function displayPinsUri(width, height, scale, centre, pointlist, colourlist){
        let uri =
            `https://www.onemap.gov.sg/api/staticmap/getStaticImage?layerchosen=default` +
            `&zoom=${scale}&height=${height}&width=${width}` +
            `&lat=${centre.get('lat')}&lng=${centre.get('long')}&points=`;

        let i = 0; while (pointlist.length>0)
        {
            uri +=
                `%5B${pointlist[i].get("lat")}%2C${pointlist[i].get("long")}%2C` +
                `%22${colourlist[i][0]}%2C${colourlist[i][1]}%2C${colourlist[i][2]}%22%5D`;

            if (++i<pointlist.length) uri += "%7C"; // this is the delimiter, |
            else break;
        }
        return uri;
    }
    function regenerateMap(pointlist, mode=0){
        switch(mode){
            case 0:
                let left = parseFloat(start.get("long"));
                let right = parseFloat(start.get("long"));
                let top = parseFloat(start.get("lat"));
                let bottom = parseFloat(start.get("lat"));
                const colourlist = [[0, 0, 0]];
                for(let i=0; i<pointlist.length; i++){
                    let y = parseFloat(pointlist[i].get("lat"));
                    let x = parseFloat(pointlist[i].get("long"));
                    if(y>top) top = y;
                    if(y<bottom) bottom = y;
                    if(x>right) right = x;
                    if(x<left) left = x;
                    colourlist.push([0,0,100]);
                }

                document.getElementById('map').src = displayPinsUri(
                    500, 500, 15,
                    new Map([["lat",(top+bottom)/2],["long",(left+right)/2]]),
                    [start].concat(pointlist),
                    colourlist
                ); break;
        }
    }
    async function submitLocationAsync() {
        const input = document.getElementById('userInput').value;
        const params = new URLSearchParams({
            category: sessionStorage.getItem("category")
        }).toString();
        try {
            // Await multiple fetch requests simultaneously
            const [response1, response2] = await Promise.all([
                fetch(addressResolverUri(input)),
                fetch(window.location.href+`api/location?${params}`)
            ]);
            // Check if both responses are okay
            if (!response1.ok) throw new Error(`Error fetching from ${url1}: ${response1.statusText}`);
            if (!response2.ok) throw new Error(`Error fetching from ${url2}: ${response2.statusText}`);

            // Await the parsing of both JSON responses
            const [startjson, locationsjson] = await Promise.all([
                response1.json(),
                response2.json()
            ]);


            const results = startjson.results[0];
            start.set('lat', results["LATITUDE"]);
            start.set('long', results["LONGITUDE"]);

            const locationcoords = locationsjson.sort(locationDirectDistanceComparator).
            map(location =>
                new Map([["long",location["Longitude"]],["lat",location["Latitude"]]]
            ));
            regenerateMap(locationcoords,0);
            // Display the results
        } catch (error) {
            // Handle any errors
            document.getElementById("debug").textContent = `Error: ${error.message}`;
        }
    }
    function submitLocation() {
        // Get the value from the input field
        const input = document.getElementById('userInput').value;


        // Create new request object for address resolving
        const addressResolveXHR = new XMLHttpRequest();
        // Add the url to request
        addressResolveXHR.open("GET",addressResolverUri(input),false);

        // Set behavior once request is completed (display the results)
        addressResolveXHR.onreadystatechange = () => {
            const results = JSON.parse(addressResolveXHR.responseText)["results"][0];
            start.set('lat', results["LATITUDE"]);
            start.set('long', results["LONGITUDE"]);
            document.getElementById('latlong').innerText = `lat: ${start.get("lat")} long: ${start.get("long")}`;
            document.getElementById('address').innerText = results["SEARCHVAL"];
        }
        const params = new URLSearchParams({
            category: sessionStorage.getItem("category")
        }).toString();
        const getLocationsXHR = new XMLHttpRequest();
        addressResolveXHR.open("GET",window.location.href+`api/location?${params}`,false);
        // Actually make it send the request
        addressResolveXHR.send();
        regenerateMap([new Map(
            [['lat',1.34425141362649],['long',103.68681806227]] //sample eligible location
        )],0);
        document.getElementById("debug").innerText = sessionStorage.getItem("category");

    }
</script>

</body>
</html>